name: Build, test, and push JavaScript App Docker image

on:
  push:
    branches:
      - "main"

jobs:
  build-test-and-push:
    runs-on: label-1

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) GitLeaks – Secret Scanning
      - name: Run GitLeaks secret scan
        uses: gitleaks/gitleaks-action@v2
        with:
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3) Setup Node (so we can generate package-lock.json in CI)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4) Generate/refresh lockfile (apply overrides)
      - name: Generate/refresh lockfile (apply overrides)
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npm ls cross-spawn glob || true

      # 5) Set IMAGE_NAME
      - name: Set image name
        run: echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/javascript-app-httpd" >> $GITHUB_ENV

      # 6) Build Docker image
      - name: Build Docker image
        run: docker build -t $IMAGE_NAME:latest .

      # 7) Trivy – Image Vulnerability Scan (fail on HIGH/CRITICAL, except ignored CVEs)
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL
          trivyignores: .trivyignore

      # 8) Run container for test
      - name: Run container for test
        run: |
          docker run -d --name javascript-app-test -p 8080:3000 $IMAGE_NAME:latest
          sleep 3
          docker stop javascript-app-test
          docker rm javascript-app-test

      # 9) Log in to Docker Hub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 10) Push image
      - name: Push image to Docker Hub
        run: docker push $IMAGE_NAME:latest

      # 11) Deploy container on the VM
      - name: Deploy container
        run: |
          docker stop javascript-app 2>/dev/null || true
          docker rm javascript-app 2>/dev/null || true
          docker run -d --name javascript-app -p 80:3000 $IMAGE_NAME:latest

      # 12) Verify deployment
      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 5
          docker ps | grep javascript-app
          echo "Container is running!"

