name: Build, test, and push JavaScript App Docker image

on:
  push:
    branches:
      - "main"

jobs:
  build-test-and-push:
    runs-on: label-1

    steps:
      # 1) Checkout your repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ” 2) GitLeaks â€“ Secret Scanning (Security Gate)
      - name: Run GitLeaks secret scan
        uses: gitleaks/gitleaks-action@v2
        with:
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3) Set an IMAGE_NAME env variable
      - name: Set image name
        run: echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/javascript-app-httpd" >> $GITHUB_ENV

      # 4) Build the Docker image from your Dockerfile
      - name: Build Docker image
        run: docker build -t $IMAGE_NAME:latest .

      # 5) Run the container to make sure it starts and serves HTTP
      - name: Run container for test
        run: |
          docker run -d --name javascript-app-test -p 8080:3000 $IMAGE_NAME:latest
          sleep 3
          docker stop javascript-app-test
          docker rm javascript-app-test

      # 6) List all Docker containers
      - name: List Docker containers
        run: docker ps -a

      # 7) Log in to Docker Hub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 8) Push the image to Docker Hub
      - name: Push image to Docker Hub
        run: docker push $IMAGE_NAME:latest

      # 9) Deploy the container on the VM
      - name: Deploy container
        run: |
          docker stop javascript-app 2>/dev/null || true
          docker rm javascript-app 2>/dev/null || true
          docker run -d --name javascript-app -p 80:3000 $IMAGE_NAME:latest

      # 10) Verify deployment
      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 5
          docker ps | grep javascript-app
          echo "Container is running!"
